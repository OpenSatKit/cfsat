<?xml version="1.0" encoding="UTF-8"?>
<!--

    Copyright 2022 Open STEMware Foundation
    All Rights Reserved.

    This program is free software; you can modify and/or redistribute it under
    the terms of the GNU Affero General Public License as published by the Free
    Software Foundation; version 3 with attribution addendums as found in the
    LICENSE.txt

    This program is distributed in the hope that it will be useful, but WITHOUT
    ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
    FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more
    details.

    This program may also be used under the terms of a commercial or enterprise
    edition license of cFSAT if purchased from the copyright holder.

    This document adheres to the Electronic Data Sheet (EDS) XML schema 
    as prescribed in CCSDS book 876.0. 
      
    Purpose: 
      This describes all interface objects for the OpenSatKit(OSK) File
      Transfer (FILE_XFER) application.
      
-->
<PackageFile xmlns="http://www.ccsds.org/schema/sois/seds">
  <Package name="FILE_XFER" shortDescription="Manage file transfers">
    <DataTypeSet>


      <!--***********************************-->
      <!--**** DataTypeSet:  Entry Types ****-->
      <!--***********************************-->
    
      <EnumeratedDataType name="BooleanUint8" shortDescription="8-bit Boolean for commands" >
        <IntegerDataEncoding sizeInBits="8" encoding="unsigned" />
        <EnumerationList>
          <Enumeration label="FALSE" value="0" shortDescription="" />
          <Enumeration label="TRUE"  value="1" shortDescription="" />
        </EnumerationList>
      </EnumeratedDataType>

      <EnumeratedDataType name="BooleanUint16" shortDescription="8-bit Boolean for commands" >
        <IntegerDataEncoding sizeInBits="16" encoding="unsigned" />
        <EnumerationList>
          <Enumeration label="FALSE" value="0" shortDescription="" />
          <Enumeration label="TRUE"  value="1" shortDescription="" />
        </EnumerationList>
      </EnumeratedDataType>

      <EnumeratedDataType name="FotpTransferState" shortDescription="" >
        <IntegerDataEncoding sizeInBits="8" encoding="unsigned" />
        <EnumerationList>
          <Enumeration label="UNDEF"     value="0" shortDescription="" />
          <Enumeration label="IDLE"      value="1" shortDescription="" />
          <Enumeration label="START"     value="2" shortDescription="" />
          <Enumeration label="SEND_DATA" value="3" shortDescription="" />
          <Enumeration label="FINISH"    value="4" shortDescription="" />
          <Enumeration label="PAUSED"    value="5" shortDescription="" />
        </EnumerationList>
      </EnumeratedDataType>


      <!--***************************************-->
      <!--**** DataTypeSet: Command Payloads ****-->
      <!--***************************************-->

      <!-- FileXfer::Fitp -->

      <ContainerDataType name="FitpStartTransfer_Payload">
        <EntryList>
          <Entry name="DestFilename" type="BASE_TYPES/PathName" shortDescription="path/filename of file to be received" />
        </EntryList>
      </ContainerDataType>

      <ArrayDataType name="FitpDataBlock" dataTypeRef="BASE_TYPES/uint8">
        <DimensionList>
           <Dimension size="${FILE_XFER/FITP_DATA_SEG_MAX_LEN}"/>
        </DimensionList>
      </ArrayDataType>
      
      <ContainerDataType name="FitpDataSegment_Payload">
        <EntryList>
          <Entry name="Id"    type="BASE_TYPES/uint16"  shortDescription="Integer identifier that increments for each sequential segement" />
          <Entry name="Len"   type="BASE_TYPES/uint16"  shortDescription="Number of data bytes in the data blosk" />
          <Entry name="Data"  type="FitpDataBlock"      shortDescription="Data must be defined last because it is variable length" />
        </EntryList>
      </ContainerDataType>

      <ContainerDataType name="FitpFinishTransfer_Payload">
        <EntryList>
          <Entry name="FileLen"           type="BASE_TYPES/uint32" shortDescription="Total file length in bytes" />
          <Entry name="FileCrc"           type="BASE_TYPES/uint32" shortDescription="File CRC" />
          <Entry name="LastDataSegmentId" type="BASE_TYPES/uint16" shortDescription="Identifer of the last data segmnet sent" />
        </EntryList>
      </ContainerDataType>


      <!-- FileXfer::Fotp -->


      <ContainerDataType name="FotpStartTransfer_Payload">
        <EntryList>
          <Entry name="DataSegLen"     type="BASE_TYPES/uint32"   shortDescription="Length of data segment telmeetry packets. Must be less than FILE_XFER/FOTP_DATA_SEG_MAX_LEN" />
          <Entry name="DataSegOffset"  type="BASE_TYPES/uint16"   shortDescription="Starting segment number. Typically 0 unless resuming an incomplete transfer" />
          <Entry name="SrcFilename"    type="BASE_TYPES/PathName" shortDescription="path/filename of file to be sent" />
        </EntryList>
      </ContainerDataType>


      <!--*****************************************-->
      <!--**** DataTypeSet: Telemetry Payloads ****-->
      <!--*****************************************-->

      
      <!-- FileXfer::App -->


      <ContainerDataType name="HkTlm_Fitp_Payload" shortDescription="File Input Transport Protocol HK data">
        <EntryList>
          <Entry name="FileTransferCnt"     type="BASE_TYPES/uint8"    shortDescription="Number of complete file transfers" />
          <Entry name="FileTransferActive"  type="BASE_TYPES/uint8"    shortDescription="Boolean indicating whether file transfer active" />
          <Entry name="LastDataSegmentId"   type="BASE_TYPES/uint16"   shortDescription="ID of the last data segment saved to file" />
          <Entry name="DataSegmentErrCnt"   type="BASE_TYPES/uint16"   shortDescription="Count of data segments with errors" />
          <Entry name="FileTransferByteCnt" type="BASE_TYPES/uint32"   shortDescription="Number of file data bytes received/written" />
          <Entry name="FileRunningCrc"      type="BASE_TYPES/uint32"   shortDescription="Running CRC of file data received" />
          <Entry name="DestFilename"        type="BASE_TYPES/PathName" shortDescription="path/filename of file being received" />
        </EntryList>
      </ContainerDataType>

      <ContainerDataType name="HkTlm_Fotp_Payload" shortDescription="File Output Transport Protocol HK data">
        <EntryList>
          <Entry name="FileTransferCnt"     type="BASE_TYPES/uint8"  shortDescription="Number of complete file transfers" />
          <Entry name="FileTransferState"   type="FotpTransferState" shortDescription="See type definition" />
          <Entry name="PausedTransferState" type="FotpTransferState" shortDescription="Identify which state was paused" />
          <Entry name="PrevSegmentFailed"   type="BooleanUint8"      shortDescription="If true then FOTP attempts to resend" />
          <Entry name="FileTransferByteCnt" type="BASE_TYPES/uint32" shortDescription="Number of file data bytes received/written" />
          <Entry name="FileRunningCrc"      type="BASE_TYPES/uint32" shortDescription="Running CRC of file data received" />

          <Entry name="DataTransferLen"     type="BASE_TYPES/uint32" shortDescription="" />
          <Entry name="FileLen"             type="BASE_TYPES/uint32" shortDescription="" />
          <Entry name="FileByteOffset"      type="BASE_TYPES/uint32" shortDescription="DataSegmentOffset*DataSegmentLen" />
          
          <Entry name="DataSegmentLen"      type="BASE_TYPES/uint16" shortDescription="Length in start transfer command" />
          <Entry name="DataSegmentOffset"   type="BASE_TYPES/uint16" shortDescription="Starting data segment" />
          <Entry name="NextDataSegmentId"   type="BASE_TYPES/uint16" shortDescription="Starting data segment" />

          <Entry name="SrcFilename"         type="BASE_TYPES/PathName" shortDescription="path/filename of file being sent" />
        </EntryList>
      </ContainerDataType>

      <ContainerDataType name="HkTlm_Payload" shortDescription="App's state and status summary, 'housekeeping data'">
        <EntryList>
          <Entry name="ValidCmdCnt"    type="BASE_TYPES/uint16" />
          <Entry name="InvalidCmdCnt"  type="BASE_TYPES/uint16" />
          <Entry name="Fitp"           type="HkTlm_Fitp_Payload" />
          <Entry name="Fotp"           type="HkTlm_Fotp_Payload" />
        </EntryList>
      </ContainerDataType>
      
      
      <!-- FileXfer::FOTP -->


      <ContainerDataType name="FotpStartTransfer_Payload" shortDescription="">
        <EntryList>
          <Entry name="DataLen"      type="BASE_TYPES/uint32" shortDescription="Either file length or file length minus commanded segment offset" />
          <Entry name="SrcFilename"  type="BASE_TYPES/PathName" shortDescription="path/filename of file being sent" />
        </EntryList>
      </ContainerDataType>

      <ArrayDataType name="FotpDataBlock" dataTypeRef="BASE_TYPES/uint8">
        <DimensionList>
           <Dimension size="${FILE_XFER/FOTP_DATA_SEG_MAX_LEN}"/>
        </DimensionList>
      </ArrayDataType>
      
      <ContainerDataType name="FotpDataSgement_Payload" shortDescription="">
        <EntryList>
          <Entry name="Id"    type="BASE_TYPES/uint16" shortDescription="Integer identifier that increments for each sequential segement" />
          <Entry name="Len"   type="BASE_TYPES/uint16" shortDescription="Either file length or file length minus commanded segment offset" />
          <Entry name="Data"  type="FotpDataBlock"     shortDescription="Data must be defined last because it is variable length" />
        </EntryList>
      </ContainerDataType>

      <ContainerDataType name="FotpDataSgement_Payload" shortDescription="">
        <EntryList>
          <Entry name="FileLen"           type="BASE_TYPES/uint32" shortDescription="Total file length in bytes" />
          <Entry name="FileCrc"           type="BASE_TYPES/uint32" shortDescription="File CRC" />
          <Entry name="LastDataSegmentId" type="BASE_TYPES/uint16" shortDescription="Identifer of the last data segmnet sent" />
        </EntryList>
      </ContainerDataType>


            
      <!--**************************************-->
      <!--**** DataTypeSet: Command Packets ****-->
      <!--**************************************-->

      <ContainerDataType name="CommandBase" baseType="CFE_HDR/CommandHeader">
      </ContainerDataType>

      <ContainerDataType name="Noop" baseType="CommandBase" shortDescription="Generate an info event message with app version">
        <ConstraintSet>
          <ValueConstraint entry="Sec.FunctionCode" value="${OSK_C_FW/NOOP_CC}" />
        </ConstraintSet>
      </ContainerDataType>

      <ContainerDataType name="Reset" baseType="CommandBase" shortDescription="Reset app to a known state">
        <ConstraintSet>
          <ValueConstraint entry="Sec.FunctionCode" value="${OSK_C_FW/RESET_CC}" />
        </ConstraintSet>
      </ContainerDataType>

      <!-- FileXfer::Fitp -->
    
      <!-- 
        There two categories of commands:
           1. User issued commands that have user goal oriented names
           2. Protocal commands used to implement FITP have technical names that describe their role in the protocol
      -->

      <ContainerDataType name="SendFile" baseType="CommandBase" shortDescription="">
        <ConstraintSet>
          <ValueConstraint entry="Sec.FunctionCode" value="${OSK_C_FW/APP_BASE_CC} + 0" />
        </ConstraintSet>
        <EntryList>
          <Entry type="FitpStartTransfer_Payload" name="Payload" />
        </EntryList>
      </ContainerDataType>

      <ContainerDataType name="SendFitpDataSegment" baseType="CommandBase" shortDescription="">
        <ConstraintSet>
          <ValueConstraint entry="Sec.FunctionCode" value="${OSK_C_FW/APP_BASE_CC} + 1" />
        </ConstraintSet>
        <EntryList>
          <Entry type="FitpDataSegment_Payload" name="Payload" />
        </EntryList>
      </ContainerDataType>
      
      <ContainerDataType name="FinsihFitpTransfer" baseType="CommandBase" shortDescription="">
        <ConstraintSet>
          <ValueConstraint entry="Sec.FunctionCode" value="${OSK_C_FW/APP_BASE_CC} + 2" />
        </ConstraintSet>
        <EntryList>
          <Entry type="FitpFinishTransfer_Payload" name="Payload" />
        </EntryList>
      </ContainerDataType>

      <ContainerDataType name="CancelSendFile" baseType="CommandBase" shortDescription="Cancel a send file transfer in progress">
        <ConstraintSet>
          <ValueConstraint entry="Sec.FunctionCode" value="${OSK_C_FW/APP_BASE_CC} + 3" />
        </ConstraintSet>
      </ContainerDataType>

      <!-- FileXfer::Fotp -->

      <ContainerDataType name="StartReceiveFile" baseType="CommandBase" shortDescription="">
        <ConstraintSet>
          <ValueConstraint entry="Sec.FunctionCode" value="${OSK_C_FW/APP_BASE_CC} + 4" />
        </ConstraintSet>
        <EntryList>
          <Entry type="FotpStartTransfer_Payload" name="Payload" />
        </EntryList>
      </ContainerDataType>

      <ContainerDataType name="PauseReceiveFile" baseType="CommandBase" shortDescription="Pause a receive file transaction">
        <ConstraintSet>
          <ValueConstraint entry="Sec.FunctionCode" value="${OSK_C_FW/APP_BASE_CC} + 5" />
        </ConstraintSet>
      </ContainerDataType>

      <ContainerDataType name="ResumeReceiveFile" baseType="CommandBase" shortDescription="Resume a receive file transaction">
        <ConstraintSet>
          <ValueConstraint entry="Sec.FunctionCode" value="${OSK_C_FW/APP_BASE_CC} + 6" />
        </ConstraintSet>
      </ContainerDataType>

      <ContainerDataType name="CancelReceiveFile" baseType="CommandBase" shortDescription="Cancel a receive file transaction">
        <ConstraintSet>
          <ValueConstraint entry="Sec.FunctionCode" value="${OSK_C_FW/APP_BASE_CC} + 7" />
        </ConstraintSet>
      </ContainerDataType>
    

      <!--****************************************-->
      <!--**** DataTypeSet: Telemetry Packets ****-->
      <!--****************************************-->

      <!-- FileMgr::App -->

      <ContainerDataType name="HkTlm" baseType="CFE_HDR/TelemetryHeader">
        <EntryList>
          <Entry type="HkTlm_Payload" name="Payload" />
        </EntryList>
      </ContainerDataType>

      <!-- FileMgr::Fotp -->

      <ContainerDataType name="FotpStartTransfer" baseType="CFE_HDR/TelemetryHeader">
        <EntryList>
          <Entry type="FotpStartTransfer_Payload" name="Payload" />
        </EntryList>
      </ContainerDataType>

      <ContainerDataType name="FotpDataSgement" baseType="CFE_HDR/TelemetryHeader">
        <EntryList>
          <Entry type="FotpDataSgement_Payload" name="Payload" />
        </EntryList>
      </ContainerDataType>

      <ContainerDataType name="FotpDataSgement" baseType="CFE_HDR/TelemetryHeader">
        <EntryList>
          <Entry type="FotpDataSgement_Payload" name="Payload" />
        </EntryList>
      </ContainerDataType>

    </DataTypeSet>

        
    <ComponentSet>
      <Component name="Application">

        <!--***********************************-->
        <!--**** Component Set: Interfaces ****-->
        <!--***********************************-->

        <RequiredInterfaceSet>
          <Interface name="CMD" shortDescription="Software bus telecommand interface" type="CFE_SB/Telecommand">
            <GenericTypeMapSet>
              <GenericTypeMap name="TelecommandDataType" type="CommandBase" />
            </GenericTypeMapSet>
          </Interface>
          <Interface name="SEND_HK" shortDescription="Send telemetry command interface" type="CFE_SB/Telecommand">
            <!-- This uses a bare spacepacket with no payload -->
            <GenericTypeMapSet>
              <GenericTypeMap name="TelecommandDataType" type="CFE_HDR/CommandHeader" />
            </GenericTypeMapSet>
          </Interface>
          <Interface name="HK_TLM" shortDescription="Software bus housekeeping telemetry interface" type="CFE_SB/Telemetry">
            <GenericTypeMapSet>
              <GenericTypeMap name="TelemetryDataType" type="HkTlm" />
            </GenericTypeMapSet>
          </Interface>
          <Interface name="DIR_LIST_TLM" shortDescription="List directory contents inn a telemetry packet" type="CFE_SB/Telemetry">
            <GenericTypeMapSet>
              <GenericTypeMap name="TelemetryDataType" type="DirListTlm" />
            </GenericTypeMapSet>
          </Interface>
          <Interface name="FILE_INFO_TLM" shortDescription="Send details about a single file in a telemetry" type="CFE_SB/Telemetry">
            <GenericTypeMapSet>
              <GenericTypeMap name="TelemetryDataType" type="FileInfoTlm" />
            </GenericTypeMapSet>
          </Interface>
          <Interface name="OPEN_FILE_TLM" shortDescription="Send list of open files in telemetry" type="CFE_SB/Telemetry">
            <GenericTypeMapSet>
              <GenericTypeMap name="TelemetryDataType" type="OpenFileTlm" />
            </GenericTypeMapSet>
          </Interface>
          <Interface name="FILE_SYS_TBL_TLM" shortDescription="Send systems telemetry" type="CFE_SB/Telemetry">
            <GenericTypeMapSet>
              <GenericTypeMap name="TelemetryDataType" type="FileSysTblTlm" />
            </GenericTypeMapSet>
          </Interface>
        </RequiredInterfaceSet>

        <!--***************************************-->
        <!--**** Component Set: Implementation ****-->
        <!--***************************************-->

        <Implementation>
          <VariableSet>
            <Variable type="BASE_TYPES/uint16" readOnly="true" name="CmdTopicId"            initialValue="${CFE_MISSION/FILEMGR_CMD_TOPICID}" />
            <Variable type="BASE_TYPES/uint16" readOnly="true" name="SendHkTopicId"         initialValue="${CFE_MISSION/FILEMGR_SEND_HK_TOPICID}" />
            <Variable type="BASE_TYPES/uint16" readOnly="true" name="HkTlmTopicId"          initialValue="${CFE_MISSION/FILEMGR_HK_TLM_TOPICID}" />
            <Variable type="BASE_TYPES/uint16" readOnly="true" name="DirListTlmTopicId"     initialValue="${CFE_MISSION/FILEMGR_DIR_LIST_TLM_TOPICID}" />
            <Variable type="BASE_TYPES/uint16" readOnly="true" name="FileInfoTlmTopicId"    initialValue="${CFE_MISSION/FILEMGR_FILE_INFO_TLM_TOPICID}" />
            <Variable type="BASE_TYPES/uint16" readOnly="true" name="OpenFileTlmTopicId"    initialValue="${CFE_MISSION/FILEMGR_OPEN_FILE_TLM_TOPICID}" />
            <Variable type="BASE_TYPES/uint16" readOnly="true" name="FileSysTblTlmTopicId"  initialValue="${CFE_MISSION/FILEMGR_FILE_SYS_TBL_TLM_TOPICID}" />
          </VariableSet>
          <!-- Assign fixed numbers to the "TopicId" parameter of each interface -->
          <ParameterMapSet>          
            <ParameterMap interface="CMD"               parameter="TopicId" variableRef="CmdTopicId" />
            <ParameterMap interface="SEND_HK"           parameter="TopicId" variableRef="SendHkTopicId" />
            <ParameterMap interface="HK_TLM"            parameter="TopicId" variableRef="HkTlmTopicId" />
            <ParameterMap interface="DIR_LIST_TLM"      parameter="TopicId" variableRef="DirListTlmTopicId" />
            <ParameterMap interface="FILE_INFO_TLM"     parameter="TopicId" variableRef="FileInfoTlmTopicId" />
            <ParameterMap interface="OPEN_FILE_TLM"     parameter="TopicId" variableRef="OpenFileTlmTopicId" />
            <ParameterMap interface="FILE_SYS_TBL_TLM"  parameter="TopicId" variableRef="FileSysTblTlmTopicId" />
          </ParameterMapSet>
        </Implementation>
      </Component>
    </ComponentSet>
    
  </Package>
</PackageFile>
